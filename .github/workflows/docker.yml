# å·¥ä½œæµåç§°ï¼šæ„å»ºå¹¶å‘å¸ƒ Docker é•œåƒ
name: ğŸ³ æ„å»ºå¹¶å‘å¸ƒ Docker é•œåƒ

# å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸åœ¨ GitHub Actions ç•Œé¢æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  workflow_dispatch:
  # æ¨é€è§¦å‘ï¼šå½“ä»£ç æ¨é€åˆ°æŒ‡å®šåˆ†æ”¯æˆ–æ ‡ç­¾æ—¶è§¦å‘
  push:
    # åˆ†æ”¯ï¼šåªç›‘å¬ master åˆ†æ”¯çš„æ¨é€
    branches:
      - master
    # æ ‡ç­¾ï¼šç›‘å¬æ‰€æœ‰æ ‡ç­¾çš„æ¨é€
    tags:
      - '*'
    # è·¯å¾„ï¼šåªç›‘å¬ä»¥ä¸‹æ–‡ä»¶æˆ–ç›®å½•çš„å˜æ›´
    paths:
      - src/**
      - api/**
      - public/**
      - Dockerfile

# ç¯å¢ƒå˜é‡é…ç½®
env:
  # Docker é•œåƒåç§°
  IMAGE_NAME: web-check
  # Docker Hub ç”¨æˆ·å
  DOCKER_USER: lissy93
  # GitHub Container Registry åœ°å€
  GHCR_REGISTRY: ghcr.io
  # Docker Hub Registry åœ°å€
  DOCKERHUB_REGISTRY: docker.io

# ä»»åŠ¡ï¼ˆJobsï¼‰å®šä¹‰
jobs:
  # ä»»åŠ¡ï¼šæ„å»ºå’Œå‘å¸ƒ Docker é•œåƒ
  docker:
    # è¿è¡Œç¯å¢ƒï¼šä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Ubuntu
    runs-on: ubuntu-latest
    # æ­¥éª¤ï¼ˆStepsï¼‰å®šä¹‰
    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç ä»“åº“
      - name: æ£€å‡ºä»£ç  ğŸ›ï¸
        uses: actions/checkout@v2

      # æ­¥éª¤ 2ï¼šæå–æ ‡ç­¾åç§°
      - name: æå–æ ‡ç­¾åç§° ğŸ·ï¸
        shell: bash
        # ä» GitHub å¼•ç”¨ä¸­æå–æ ‡ç­¾åï¼Œå¹¶å°†æ–œæ æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
        run: echo "GIT_TAG=$(echo ${GITHUB_REF#refs/tags/} | sed 's/\//_/g')" >> $GITHUB_ENV

      # æ­¥éª¤ 3ï¼šè®¡ç®—é•œåƒæ ‡ç­¾
      - name: è®¡ç®—é•œåƒæ ‡ç­¾ ğŸ”–
        id: compute-tags
        run: |
          # å¦‚æœæ˜¯ master åˆ†æ”¯ï¼Œä½¿ç”¨ latest æ ‡ç­¾
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "GHCR_TAG=${GHCR_REGISTRY}/${DOCKER_USER}/${IMAGE_NAME}:latest" >> $GITHUB_ENV
            echo "DOCKERHUB_TAG=${DOCKERHUB_REGISTRY}/${DOCKER_USER}/${IMAGE_NAME}:latest" >> $GITHUB_ENV
          # å¦‚æœæ˜¯æ ‡ç­¾æ¨é€ï¼Œä½¿ç”¨æ ‡ç­¾åä½œä¸ºé•œåƒæ ‡ç­¾
          else
            echo "GHCR_TAG=${GHCR_REGISTRY}/${DOCKER_USER}/${IMAGE_NAME}:${GIT_TAG}" >> $GITHUB_ENV
            echo "DOCKERHUB_TAG=${DOCKERHUB_REGISTRY}/${DOCKER_USER}/${IMAGE_NAME}:${GIT_TAG}" >> $GITHUB_ENV
          fi

      # æ­¥éª¤ 4ï¼šè®¾ç½® QEMUï¼ˆç”¨äºå¤šæ¶æ„æ„å»ºï¼‰
      - name: è®¾ç½® QEMU ğŸ§
        uses: docker/setup-qemu-action@v1

      # æ­¥éª¤ 5ï¼šè®¾ç½® Docker Buildxï¼ˆDocker çš„å¢å¼ºæ„å»ºå·¥å…·ï¼‰
      - name: è®¾ç½® Docker Buildx ğŸ³
        uses: docker/setup-buildx-action@v1

      # æ­¥éª¤ 6ï¼šç™»å½•åˆ° GitHub Container Registry
      - name: ç™»å½•åˆ° GitHub Container Registry ğŸ”‘
        uses: docker/login-action@v1
        with:
          # Registry åœ°å€
          registry: ${{ env.GHCR_REGISTRY }}
          # ç”¨æˆ·åï¼šä½¿ç”¨ GitHub Actions çš„è§¦å‘è€…
          username: ${{ github.actor }}
          # å¯†ç ï¼šä½¿ç”¨ GitHub Token
          password: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤ 7ï¼šç™»å½•åˆ° DockerHub
      - name: ç™»å½•åˆ° DockerHub ğŸ”‘
        uses: docker/login-action@v1
        with:
          # Registry åœ°å€
          registry: ${{ env.DOCKERHUB_REGISTRY }}
          # ç”¨æˆ·åï¼šä»ç¯å¢ƒå˜é‡ä¸­è·å–
          username: ${{ env.DOCKER_USER }}
          # å¯†ç ï¼šä» Secrets ä¸­è·å–
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # æ­¥éª¤ 8ï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ ğŸ› ï¸
        uses: docker/build-push-action@v2
        with:
          # æ„å»ºä¸Šä¸‹æ–‡ï¼šå½“å‰ç›®å½•
          context: .
          # Dockerfile è·¯å¾„
          file: ./Dockerfile
          # æ¨é€åˆ°é•œåƒä»“åº“
          push: true
          # æ”¯æŒçš„å¹³å°æ¶æ„ï¼šAMD64 å’Œ ARM64
          platforms: linux/amd64,linux/arm64/v8
          # é•œåƒæ ‡ç­¾åˆ—è¡¨
          tags: |
            ${{ env.GHCR_TAG }}
            ${{ env.DOCKERHUB_TAG }}
